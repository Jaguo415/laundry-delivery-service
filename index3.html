<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luna Laundry - Premium Laundry Delivery Service</title>
  <link rel="stylesheet" href="leaflet.css" />
  <style>
    /* Keep existing styles minimal here if any; adding timeline styles */
    .timeline { display:flex; gap:12px; overflow-x:auto; padding:10px; align-items:center; }
    .timeline-item { flex:0 0 auto; padding:8px 10px; border-radius:8px; background:#f3f4f6; cursor:pointer; border:1px solid #e5e7eb; }
    .timeline-item.active { background:#d1fae5; border-color:#34d399; }
    .timeline-controls { display:flex; align-items:center; gap:8px; padding:8px 10px; }
    .play-btn { display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:50%; background:#10b981; color:white; border:none; cursor:pointer; transition:transform 0.2s ease; }
    .play-btn.playing { animation: pulse 1.2s ease-in-out infinite; }
    @keyframes pulse { 0%,100%{ transform:scale(1);} 50%{ transform:scale(1.08);} }
  </style>
</head>
<body>
  <!-- Existing content above map remains -->
  <div id="map" style="height:380px; border-radius:12px; overflow:hidden; border:1px solid #e5e7eb;"></div>

  <div class="timeline-controls">
    <button id="playToggle" class="play-btn" aria-label="Play timeline">▶</button>
    <div id="currentStepLabel"></div>
  </div>
  <div id="serviceTimeline" class="timeline" role="list">
    <!-- Example timeline items; if items already exist in page, JS will hydrate them -->
    <div class="timeline-item" data-lat="37.7749" data-lng="-122.4194" data-label="Pickup requested" role="listitem">Pickup requested</div>
    <div class="timeline-item" data-lat="37.784" data-lng="-122.409" data-label="Driver en route" role="listitem">Driver en route</div>
    <div class="timeline-item" data-lat="37.792" data-lng="-122.401" data-label="Picked up" role="listitem">Picked up</div>
    <div class="timeline-item" data-lat="37.804" data-lng="-122.271" data-label="At facility" role="listitem">At facility</div>
    <div class="timeline-item" data-lat="37.7749" data-lng="-122.4194" data-label="Out for delivery" role="listitem">Out for delivery</div>
    <div class="timeline-item" data-lat="37.768" data-lng="-122.431" data-label="Delivered" role="listitem">Delivered</div>
  </div>

  <script src="leaflet.js"></script>
  <script>
    // Initialize map if not already present
    const mapEl = document.getElementById('map');
    let map, marker;
    if (mapEl) {
      map = L.map('map', { zoomControl: true });
      const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
      });
      tiles.addTo(map);
    }

    // Build steps from timeline items
    const tlEl = document.getElementById('serviceTimeline');
    const items = tlEl ? Array.from(tlEl.querySelectorAll('.timeline-item')) : [];
    const steps = items.map((el) => ({
      el,
      lat: parseFloat(el.dataset.lat),
      lng: parseFloat(el.dataset.lng),
      label: el.dataset.label || el.textContent.trim()
    }));

    const currentLabel = document.getElementById('currentStepLabel');
    let currentIndex = 0;
    let playing = false;
    let playTimer = null;

    function setActive(index, opts = { pan: true }) {
      if (!steps.length) return;
      currentIndex = ((index % steps.length) + steps.length) % steps.length; // wrap
      steps.forEach((s, i) => s.el.classList.toggle('active', i === currentIndex));
      const s = steps[currentIndex];
      if (currentLabel) currentLabel.textContent = s.label;
      if (map) {
        const latlng = [s.lat, s.lng];
        if (!marker) {
          marker = L.marker(latlng).addTo(map);
          map.setView(latlng, 13);
        } else {
          marker.setLatLng(latlng);
          if (opts.pan) map.panTo(latlng, { animate: true, duration: 0.8 });
        }
      }
    }

    // Click on timeline item syncs marker and pans
    items.forEach((el, i) => {
      el.addEventListener('click', () => {
        pause();
        setActive(i, { pan: true });
      });
    });

    // Play/Pause logic with simple animation
    const playBtn = document.getElementById('playToggle');
    function play() {
      if (playing || !steps.length) return;
      playing = true;
      if (playBtn) { playBtn.classList.add('playing'); playBtn.textContent = '⏸'; playBtn.setAttribute('aria-label', 'Pause timeline'); }
      playTimer = setInterval(() => {
        setActive(currentIndex + 1, { pan: true });
      }, 1500);
    }
    function pause() {
      playing = false;
      if (playBtn) { playBtn.classList.remove('playing'); playBtn.textContent = '▶'; playBtn.setAttribute('aria-label', 'Play timeline'); }
      if (playTimer) { clearInterval(playTimer); playTimer = null; }
    }
    if (playBtn) {
      playBtn.addEventListener('click', () => {
        if (playing) pause(); else play();
      });
    }

    // Initialize first step
    if (steps.length) setActive(0, { pan: false });
  </script>
</body>
</html>
